<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zen Admin Panel</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #D32F2F;
            --primary-dark: #b71c1c;
            --bg: #f8fafc;
            --surface: #ffffff;
            --text-main: #1e293b;
            --text-secondary: #64748b;
            --border: #e2e8f0;
            --sidebar-width: 260px;
            --header-height: 64px;
            --transition-speed: 0.3s;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg);
            color: var(--text-main);
            overflow-x: hidden;
        }

        /* --- Transitions & Animations --- */
        .fade-in {
            animation: fadeIn var(--transition-speed) ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .slide-up {
            animation: slideUp 0.4s ease-out;
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* --- Login Screen --- */
        #login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg);
            z-index: 2000;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .login-box {
            background: var(--surface);
            padding: 2.5rem;
            border-radius: 16px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
        }

        /* --- Layout --- */
        .app-layout {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar (Desktop & Mobile Drawer) */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--surface);
            border-right: 1px solid var(--border);
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            transition: transform var(--transition-speed) ease;
        }

        .sidebar-header {
            height: var(--header-height);
            display: flex;
            align-items: center;
            padding: 0 1.5rem;
            border-bottom: 1px solid var(--border);
            font-weight: 700;
            color: var(--primary);
            font-size: 1.25rem;
        }

        .nav-links {
            list-style: none;
            padding: 1.5rem 1rem;
            flex: 1;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            color: var(--text-secondary);
            text-decoration: none;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            transition: all 0.2s;
            font-weight: 500;
            cursor: pointer;
        }

        .nav-link:hover,
        .nav-link.active {
            background: #fff1f2;
            /* Light red tint */
            color: var(--primary);
        }

        .sidebar-footer {
            padding: 1.5rem;
            border-top: 1px solid var(--border);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            transition: margin-left var(--transition-speed) ease;
        }

        /* Mobile Header */
        .mobile-header {
            height: var(--header-height);
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            display: none;
            /* Hidden on desktop */
            align-items: center;
            justify-content: space-between;
            padding: 0 1.5rem;
            position: sticky;
            top: 0;
            z-index: 900;
        }

        .hamburger {
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .hamburger span {
            display: block;
            width: 24px;
            height: 2px;
            background: var(--text-main);
            transition: 0.3s;
        }

        /* Content Container */
        .container {
            padding: 2rem;
            max-width: 1000px;
            margin: 0 auto;
            width: 100%;
        }

        /* --- Components --- */
        .card {
            background: var(--surface);
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
            border: 1px solid var(--border);
        }

        .card h3 {
            margin-bottom: 1.5rem;
            color: var(--text-main);
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .input-group {
            margin-bottom: 1.25rem;
        }

        .input-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            font-size: 0.875rem;
            color: var(--text-main);
        }

        .input-group input,
        .input-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-family: inherit;
            font-size: 0.95rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .input-group input:focus,
        .input-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(211, 47, 47, 0.1);
        }

        .row {
            display: flex;
            gap: 1rem;
        }

        .row>div {
            flex: 1;
        }

        button {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-sm {
            padding: 0.4rem 0.8rem;
            font-size: 0.8rem;
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-secondary);
        }

        .btn-outline:hover {
            background: #f1f5f9;
            color: var(--text-main);
        }

        .btn-del {
            background: #fee2e2;
            color: #ef4444;
        }

        .btn-del:hover {
            background: #fca5a5;
            color: #7f1d1d;
        }

        .btn-success {
            background: #22c55e;
            color: white;
        }

        .btn-success:hover {
            background: #16a34a;
        }

        /* List Items */
        .item-list {
            list-style: none;
        }

        .item-list li {
            background: #fff;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: transform 0.2s;
        }

        .item-list li:hover {
            transform: translateX(2px);
            border-color: #cbd5e1;
        }

        /* Save Status */
        .save-bar {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--text-main);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 50px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 1rem;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 100;
        }

        .save-bar.show {
            transform: translateY(0);
            opacity: 1;
        }

        .save-bar.success {
            background: #064e3b;
        }

        /* Dark Green */
        .save-bar.error {
            background: #7f1d1d;
        }

        /* Dark Red */

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                width: 280px;
                box-shadow: 4px 0 24px rgba(0, 0, 0, 0.1);
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .mobile-header {
                display: flex;
            }

            .row {
                flex-direction: column;
                gap: 0;
            }

            .container {
                padding: 1rem;
            }

            /* Overlay when menu is open */
            .overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.4);
                z-index: 999;
                opacity: 0;
                visibility: hidden;
                transition: 0.3s;
            }

            .overlay.active {
                opacity: 1;
                visibility: visible;
            }
        }
    </style>
</head>

<body>

    <!-- Login Screen -->
    <div id="login-screen" class="fade-in">
        <div class="login-box slide-up">
            <h2 style="color: var(--primary); margin-bottom: 0.5rem; font-weight: 700;">Zen Admin</h2>
            <p style="margin-bottom: 2rem; color: var(--text-secondary); font-size: 0.9rem;">Enter your GitHub Token to
                access the dashboard.</p>
            <div class="input-group">
                <input type="password" id="gh-token" placeholder="ghp_xxxxxxxxxxxx...">
            </div>
            <button class="btn-primary" style="width: 100%;" onclick="login()">Access Dashboard</button>
        </div>
    </div>

    <!-- Main App -->
    <div id="admin-app" style="display:none;" class="app-layout">

        <!-- Mobile Overlay -->
        <div class="overlay" onclick="toggleSidebar()"></div>

        <!-- Sidebar Navigation -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                Zen Admin
            </div>
            <nav class="nav-links">
                <a class="nav-link active" onclick="scrollToSection('dashboard', this)">Dashboard</a>
                <a class="nav-link" onclick="scrollToSection('repo-settings', this)">Repo Settings</a>
                <a class="nav-link" onclick="scrollToSection('carousel', this)">Carousel</a>
                <a class="nav-link" onclick="scrollToSection('products', this)">Products</a>
            </nav>
            <div class="sidebar-footer">
                <button onclick="logout()" class="btn-outline"
                    style="width: 100%; justify-content: center;">Logout</button>
            </div>
        </aside>

        <!-- Content Area -->
        <main class="main-content">
            <!-- Mobile Header -->
            <header class="mobile-header">
                <span style="font-weight: 700; color: var(--primary);">Zen Admin</span>
                <button class="hamburger" onclick="toggleSidebar()">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </header>

            <div class="container fade-in">

                <!-- Dashboard / Welcome -->
                <div id="dashboard" class="card slide-up">
                    <h3>Welcome Back</h3>
                    <p style="color: var(--text-secondary);">Manage your website content with peace of mind. All changes
                        are saved directly to GitHub.</p>
                </div>

                <!-- Repo Settings -->
                <div id="repo-settings" class="card">
                    <h3>Repository Configuration</h3>
                    <div class="row">
                        <div class="input-group">
                            <label>GitHub Username (Owner)</label>
                            <input type="text" id="repo-owner" value="codemdragon">
                        </div>
                        <div class="input-group">
                            <label>Repository Name</label>
                            <input type="text" id="repo-name" value="gift-delivery-pakistan">
                        </div>
                    </div>
                    <div
                        style="background: #eff6ff; padding: 1rem; border-radius: 8px; color: #1e40af; font-size: 0.9rem;">
                        <strong>Note:</strong> Ensure 'db.json' exists in 'data/' folder of your repo.
                    </div>
                </div>

                <!-- Carousel -->
                <div id="carousel" class="card">
                    <h3>
                        Carousel Images
                        <span style="font-size: 0.8rem; font-weight: 400; color: var(--text-secondary);">Top banner
                            slides</span>
                    </h3>
                    <ul class="item-list" id="carousel-list">
                        <!-- Items rendered here -->
                    </ul>
                    <hr style="border: 0; border-top: 1px dashed var(--border); margin: 1.5rem 0;">
                    <div class="input-group">
                        <label>Add New Slide</label>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <input type="text" id="new-carousel-img" placeholder="Paste Image URL"
                                style="flex: 1; min-width: 200px;">
                            <input type="file" id="new-carousel-file" accept="image/*" style="display:none;"
                                onchange="handleFileSelect(this, 'new-carousel-img')">
                            <button class="btn-outline"
                                onclick="document.getElementById('new-carousel-file').click()">Upload File</button>
                        </div>
                        <button class="btn-primary" id="btn-add-carousel" onclick="addCarousel()"
                            style="margin-top: 1rem; width: 100%;">Add to Carousel</button>
                    </div>
                </div>

                <!-- Products -->
                <div id="products" class="card">
                    <h3>Product Catalog</h3>
                    <ul class="item-list" id="product-list">
                        <!-- Products rendered here -->
                    </ul>

                    <hr style="border: 0; border-top: 1px dashed var(--border); margin: 2rem 0;">

                    <h3>Product Editor</h3>
                    <div class="row">
                        <div class="input-group">
                            <label>Product Name</label>
                            <input type="text" id="new-name" placeholder="E.g. Rose Scented Candle">
                        </div>
                        <div class="input-group">
                            <label>Unique ID</label>
                            <input type="text" id="new-id" placeholder="e.g. rose-candle-01">
                        </div>
                    </div>

                    <div class="input-group">
                        <label>Description</label>
                        <textarea id="new-desc" rows="3" placeholder="Describe the product..."></textarea>
                    </div>

                    <div class="input-group">
                        <label>Product Image</label>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <input type="text" id="new-img" placeholder="Paste Image URL or Upload"
                                style="flex: 1; min-width: 200px;">
                            <input type="file" id="new-img-file" accept="image/*" style="display:none;"
                                onchange="handleFileSelect(this, 'new-img', 'img-preview')">
                            <button class="btn-outline" onclick="document.getElementById('new-img-file').click()">Upload
                                File</button>
                        </div>
                        <img id="img-preview" src="" alt=""
                            style="display:none; width: 100%; max-width: 300px; height: 200px; object-fit: cover; border-radius: 8px; margin-top: 1rem; border: 1px solid var(--border);">
                    </div>

                    <div class="row" style="margin-top: 1.5rem;">
                        <button class="btn-outline" onclick="resetProductForm()">Clear Form</button>
                        <button class="btn-primary" id="btn-add-product" onclick="addProduct()">Create Product</button>
                    </div>
                </div>

                <!-- Finalize -->
                <div class="card"
                    style="position: sticky; bottom: 1rem; z-index: 10; border-color: var(--primary); background: #fef2f2;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                        <div>
                            <h3 style="margin:0; color: var(--primary);">Save Changes</h3>
                            <p style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 0.25rem;">Push all
                                updates to the live website.</p>
                        </div>
                        <button class="btn-primary btn-success" onclick="saveToGitHub()">Publish Now</button>
                    </div>
                </div>

                <div style="height: 50px;"></div> <!-- Spacer -->

            </div>
        </main>
    </div>

    <!-- Toast Notification -->
    <div id="save-status" class="save-bar">
        <span id="save-msg">Saving...</span>
    </div>

    <script>
        // --- State ---
        let API_URL = '';
        let CURRENT_SHA = '';
        let token = localStorage.getItem('zen_gh_token');
        let db = { carouselImages: [], products: [], sizes: [] };
        let editingProductIndex = null;

        // --- Init ---
        if (token) {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('admin-app').style.display = 'flex';
            loadDb();
        }

        // --- UI Logic ---
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
            document.querySelector('.overlay').classList.toggle('active');
        }

        function scrollToSection(id, el) {
            // Mobile: close sidebar
            document.getElementById('sidebar').classList.remove('active');
            document.querySelector('.overlay').classList.remove('active');

            // Highlight nav
            document.querySelectorAll('.nav-link').forEach(a => a.classList.remove('active'));
            if (el) el.classList.add('active');

            // Scroll
            const element = document.getElementById(id);
            if (element) {
                const headerOffset = 80;
                const elementPosition = element.getBoundingClientRect().top;
                const offsetPosition = elementPosition + window.pageYOffset - headerOffset;
                window.scrollTo({ top: offsetPosition, behavior: "smooth" });
            }
        }

        function handleFileSelect(input, targetId, previewId) {
            const file = input.files[0];
            if (!file) return;
            // Update preview immediately if exists
            if (previewId) {
                const preview = document.getElementById(previewId);
                preview.src = URL.createObjectURL(file);
                preview.style.display = 'block';
            }
            // We don't upload yet, just ready the file for the specific action button (add/save)
        }

        function showToast(msg, type = 'info') {
            const bar = document.getElementById('save-status');
            const txt = document.getElementById('save-msg');
            txt.innerText = msg;
            bar.className = 'save-bar show';
            if (type === 'success') bar.classList.add('success');
            if (type === 'error') bar.classList.add('error');

            setTimeout(() => {
                bar.className = 'save-bar';
            }, 3000);
        }

        // --- Core Logic ---
        function login() {
            const inputToken = document.getElementById('gh-token').value;
            if (inputToken.startsWith('ghp_') || inputToken.startsWith('github_pat_')) {
                localStorage.setItem('zen_gh_token', inputToken);
                token = inputToken;
                location.reload();
            } else { alert('Invalid Token Format'); }
        }

        function logout() { localStorage.removeItem('zen_gh_token'); location.reload(); }

        async function loadDb() {
            const owner = document.getElementById('repo-owner').value;
            const repo = document.getElementById('repo-name').value;
            API_URL = `https://api.github.com/repos/${owner}/${repo}/contents/data/db.json`;
            try {
                const res = await fetch(API_URL, { headers: { 'Authorization': `token ${token}` } });
                if (!res.ok) throw new Error("Connection failed. Check permissions.");
                const data = await res.json();
                CURRENT_SHA = data.sha;
                // Decode UTF-8 correctly
                const decodedContent = decodeURIComponent(escape(atob(data.content)));
                db = JSON.parse(decodedContent);
                renderLists();
            } catch (err) {
                alert("Could not load data. Ensure your Token is valid, Repo Name is correct, and /data/db.json exists.");
            }
        }

        function renderLists() {
            document.getElementById('carousel-list').innerHTML = db.carouselImages.map((url, i) => `
                <li class="slide-up" style="animation-delay: ${i * 0.05}s">
                    <div style="display:flex; align-items:center; gap:10px; overflow:hidden;">
                        <img src="${url}" style="width:40px; height:40px; border-radius:4px; object-fit:cover;">
                        <span style="font-size:0.85rem; color: var(--text-secondary); text-overflow:ellipsis; white-space:nowrap; overflow:hidden;">${url}</span>
                    </div>
                    <button class="btn-sm btn-del" onclick="removeItem('carousel', ${i})">Delete</button>
                </li>
            `).join('');

            document.getElementById('product-list').innerHTML = db.products.map((p, i) => `
                <li class="product-row slide-up" style="animation-delay: ${i * 0.05}s">
                    <div style="display:flex; align-items:center; gap:1rem;">
                        ${p.imageUrl ? `<img src="${p.imageUrl}" style="width:50px; height:50px; border-radius:6px; object-fit:cover;">` : ''}
                        <div>
                            <strong style="display:block; color:var(--text-main);">${p.name}</strong>
                            <span style="font-size:0.8rem; color:var(--text-secondary);">${truncate(p.description, 40)}</span>
                        </div>
                    </div>
                    <div style="display:flex; gap:0.5rem;">
                        <button class="btn-sm btn-outline" onclick="editProduct(${i})">Edit</button>
                        <button class="btn-sm btn-del" onclick="removeItem('product', ${i})">Del</button>
                    </div>
                </li>
            `).join('');
        }

        function truncate(text, max = 40) {
            if (!text) return '';
            return text.length > max ? text.slice(0, max) + 'â€¦' : text;
        }

        const toBase64 = file => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result.split(',')[1]);
            reader.onerror = error => reject(error);
        });

        async function uploadImage(fileInputId, prefix) {
            const fileInput = document.getElementById(fileInputId);
            if (fileInput.files.length === 0) return null;

            const file = fileInput.files[0];
            const fileName = `${prefix}-${Date.now()}.${file.name.split('.').pop()}`;
            const owner = document.getElementById('repo-owner').value;
            const repo = document.getElementById('repo-name').value;
            const uploadUrl = `https://api.github.com/repos/${owner}/${repo}/contents/assets/${fileName}`;

            const content = await toBase64(file);

            const res = await fetch(uploadUrl, {
                method: 'PUT',
                headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: `Upload ${fileName}`, content })
            });

            if (!res.ok) throw new Error("GitHub Upload Failed");
            const data = await res.json();
            return data.content.download_url; // Use the raw download URL
        }

        // --- Actions ---

        async function addCarousel() {
            const btn = document.getElementById('btn-add-carousel');
            let url = document.getElementById('new-carousel-img').value;

            try {
                btn.disabled = true; btn.innerText = "Uploading...";

                // Check if file upload is needed
                const uploadedUrl = await uploadImage('new-carousel-file', 'carousel');
                if (uploadedUrl) url = uploadedUrl;

                if (url) {
                    db.carouselImages.push(url);
                    renderLists();
                    document.getElementById('new-carousel-img').value = '';
                    document.getElementById('new-carousel-file').value = '';
                    showToast('Image added to list', 'success');
                } else {
                    alert("Please enter a URL or select a file.");
                }
            } catch (e) { alert(e.message); }
            finally { btn.disabled = false; btn.innerText = "Add to Carousel"; }
        }

        function editProduct(index) {
            const p = db.products[index];
            editingProductIndex = index;
            document.getElementById('new-id').value = p.id;
            document.getElementById('new-id').disabled = true;
            document.getElementById('new-name').value = p.name;
            document.getElementById('new-desc').value = p.description;
            document.getElementById('new-img').value = p.imageUrl;

            const preview = document.getElementById('img-preview');
            if (p.imageUrl) {
                preview.src = p.imageUrl;
                preview.style.display = 'block';
            } else {
                preview.style.display = 'none';
            }

            document.getElementById('btn-add-product').innerText = "Update Product";
            document.getElementById('btn-add-product').classList.remove('btn-primary');
            document.getElementById('btn-add-product').classList.add('btn-success');

            scrollToSection('products');
        }

        async function addProduct() {
            const btn = document.getElementById('btn-add-product');
            const id = document.getElementById('new-id').value;
            const name = document.getElementById('new-name').value;
            const desc = document.getElementById('new-desc').value;
            let url = document.getElementById('new-img').value;

            if (!id || !name) return alert("ID and Name required");

            try {
                btn.disabled = true;
                btn.innerText = "Processing...";

                const uploadedUrl = await uploadImage('new-img-file', `prod-${id}`);
                if (uploadedUrl) url = uploadedUrl;

                const productData = { id, name, description: desc, imageUrl: url };

                if (editingProductIndex !== null) {
                    db.products[editingProductIndex] = productData;
                    editingProductIndex = null;
                    showToast('Product Updated', 'success');
                } else {
                    db.products.push(productData);
                    showToast('Product Created', 'success');
                }

                renderLists();
                resetProductForm();

            } catch (e) {
                alert(e.message);
            } finally {
                btn.disabled = false;
                btn.innerText = "Create Product";
                btn.classList.add('btn-primary');
                btn.classList.remove('btn-success');
            }
        }

        function resetProductForm() {
            ['new-name', 'new-id', 'new-desc', 'new-img'].forEach(id => {
                document.getElementById(id).value = '';
            });
            document.getElementById('new-id').disabled = false;
            document.getElementById('new-img-file').value = '';
            document.getElementById('btn-add-product').innerText = "Create Product";
            document.getElementById('btn-add-product').classList.add('btn-primary');
            document.getElementById('btn-add-product').classList.remove('btn-success');

            const preview = document.getElementById('img-preview');
            preview.src = '';
            preview.style.display = 'none';
            editingProductIndex = null;
        }

        function removeItem(type, index) {
            if (confirm('Are you sure you want to remove this item?')) {
                if (type === 'carousel') db.carouselImages.splice(index, 1);
                else db.products.splice(index, 1);
                renderLists();
            }
        }

        async function saveToGitHub() {
            showToast('Saving to GitHub...', 'info');
            try {
                // Encode to Base64 (handling UTF-8)
                const contentStr = JSON.stringify(db, null, 2);
                const contentBase64 = btoa(unescape(encodeURIComponent(contentStr)));

                const res = await fetch(API_URL, {
                    method: 'PUT',
                    headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: "Update via Zen Admin",
                        content: contentBase64,
                        sha: CURRENT_SHA
                    })
                });

                if (!res.ok) throw new Error('Update Failed');

                const data = await res.json();
                CURRENT_SHA = data.content.sha;
                showToast('Changes Published!', 'success');
            } catch (err) {
                showToast('Error: ' + err.message, 'error');
            }
        }
    </script>
</body>

</html>